name: Merge Main to Stage

permissions:
  contents: write 
  
on:
  workflow_dispatch:

jobs:
  merge_to_stage:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Repository
      uses: actions/checkout@v3

    - name: Set Up Git User
      run: |
        git config --global user.name "codeBKashif"
        git config --global user.email "temujin398@gmail.com"

    - name: Merge Main into Stage
      run: |
        git fetch origin stage
        git fetch origin main
        
        git checkout stage
        
        git merge origin/main --no-ff --allow-unrelated-histories -m "Merged main into stage"
        
        # Handle file deletions and renames explicitly
        # Stage all changes (including deleted files and renames)
        git add -A
        
        # Check if there are any renames
        git status
        if [ -z "$(git status --porcelain)" ]; then
          echo "No changes to commit after merge."
          git push origin stage
          exit 0
        fi
        
        # Commit the changes (including renames and deletions)
        git commit -m "Merged main into stage and handled renames/deletions"
        
        git push origin stage
